<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Uploader & Galerie</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e9ebee; margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }
        .card {
            background-color: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            text-align: center; width: 100%; max-width: 600px; box-sizing: border-box;
        }
        h1 { color: #1c1e21; margin: 0 0 20px 0; font-size: 24px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .hidden { display: none !important; }
        .button-group { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }
        button { padding: 12px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; font-weight: bold; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status, #gallery-status { margin-top: 15px; font-weight: bold; min-height: 24px; color: #606770; }

        /* -- Styles de la capture -- */
        #photo-preview { max-width: 100%; border-radius: 8px; border: 1px solid #ddd; }
        #open-camera-btn { background-color: #1877f2; color: white; padding: 20px; font-size: 18px; }
        #send { background-color: #42b72a; color: white; }
        #retake { background-color: #f5f6f7; color: #4b4f56; border: 1px solid #ccd0d5; }
        
        /* -- Styles pour la vue Plein Écran -- */
        #fullscreen-camera-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        #fullscreen-video { width: 100%; height: 100%; object-fit: cover; }
        #fullscreen-controls {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px; box-sizing: border-box;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            display: flex; justify-content: space-between; align-items: center;
        }
        #snap-fullscreen-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background-color: white; border: 4px solid rgba(255,255,255,0.5); padding: 0;
            margin: 0 auto; /* Pour le centrer */
        }
        /* NOUVEAU : Bouton de swap */
        #swap-camera-btn {
            background: rgba(255,255,255,0.2); color: white; font-size: 24px;
            border: none; width: 50px; height: 50px; border-radius: 50%;
            padding: 0; line-height: 50px;
        }
        #close-fullscreen-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.4); color: white; font-size: 24px;
            border: none; width: 44px; height: 44px; border-radius: 50%;
            padding: 0; line-height: 44px;
        }
        /* Placeholder pour équilibrer le flexbox */
        .flex-placeholder { width: 50px; } 

        /* -- Styles de la Galerie -- */
        #image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; }
        #image-grid a { display: block; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; }
        #image-grid img { width: 100%; height: 120px; object-fit: cover; display: block; }
        #image-grid a:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <!-- (Le HTML de capture-card et gallery-card reste inchangé) -->
    <div id="capture-card" class="card">...</div>
    <div id="gallery-card" class="card">...</div>
    
    <!-- Vue plein écran pour la caméra (avec le nouveau bouton) -->
    <div id="fullscreen-camera-view" class="hidden">
        <video id="fullscreen-video" autoplay playsinline></video>
        <div id="fullscreen-controls">
            <!-- NOUVEAU : Placeholder pour l'alignement -->
            <div class="flex-placeholder"></div>
            <button id="snap-fullscreen-btn" title="Prendre la photo"></button>
            <!-- NOUVEAU : Bouton pour changer de caméra -->
            <button id="swap-camera-btn" title="Changer de caméra">🔄</button>
        </div>
        <button id="close-fullscreen-btn" title="Fermer la caméra">×</button>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzbdC-60zvJpOXhWBIgV3kdkIjI1u5M0m-5tajQrpWbrMOHfeNYWuBcflraX_5T4rr4/exec";

        // ... (Références aux éléments) ...
        const fullscreenView = document.getElementById('fullscreen-camera-view');
        const fullscreenVideo = document.getElementById('fullscreen-video');

        // ... (Références aux boutons) ...
        const snapFullscreenBtn = document.getElementById('snap-fullscreen-btn');
        const closeFullscreenBtn = document.getElementById('close-fullscreen-btn');
        // NOUVEAU : Référence au bouton de swap
        const swapCameraBtn = document.getElementById('swap-camera-btn');

        let photoDataUrl = null;
        let stream = null;
        // NOUVEAU : Variable pour garder en mémoire la caméra active
        let currentFacingMode = 'environment';

        // --- Fonctions de la Caméra ---

        // Helper pour arrêter proprement le stream
        function stopCurrentStream() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }

        async function startCameraStream() {
            stopCurrentStream(); // Toujours arrêter le précédent avant d'en démarrer un nouveau
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: currentFacingMode } 
                });
                fullscreenVideo.srcObject = stream;
            } catch (err) {
                statusMsg.textContent = `Erreur: Impossible d'accéder à la caméra (${currentFacingMode}).`;
                closeFullscreenCamera();
            }
        }

        function openFullscreenCamera() {
            fullscreenView.classList.remove('hidden');
            startCameraStream();
        }

        function closeFullscreenCamera() {
            stopCurrentStream();
            fullscreenView.classList.add('hidden');
        }

        // NOUVEAU : Fonction pour basculer la caméra
        function swapCamera() {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            startCameraStream();
        }

        // --- Fonctions Principales (inchangées pour la plupart) ---
        function takePicture() {
            // ... (code inchangé)
        }
        async function loadGallery() {
            // ... (code inchangé)
        }

        // --- Événements des boutons ---
        openCameraBtn.addEventListener('click', openFullscreenCamera);
        closeFullscreenBtn.addEventListener('click', closeFullscreenCamera);
        snapFullscreenBtn.addEventListener('click', takePicture);
        retakeBtn.addEventListener('click', openFullscreenCamera);
        // NOUVEAU : Événement pour le bouton de swap
        swapCameraBtn.addEventListener('click', swapCamera);

        sendBtn.addEventListener('click', async () => {
            // ... (code inchangé)
        });
        
        // --- Démarrage et code existant ---
        // (Collez ici le reste de votre code JS qui n'a pas été montré ci-dessus)
        // Pour être sûr, voici le code complet du script JS
        const startView = document.getElementById('start-view');
        const previewView = document.getElementById('preview-view');
        const photoPreview = document.getElementById('photo-preview');
        const statusMsg = document.getElementById('status');
        const galleryStatus = document.getElementById('gallery-status');
        const imageGrid = document.getElementById('image-grid');
        const canvas = document.getElementById('canvas');
        const openCameraBtn = document.getElementById('open-camera-btn');
        const sendBtn = document.getElementById('send');
        const retakeBtn = document.getElementById('retake');

        function takePicture() {
            const context = canvas.getContext('2d');
            canvas.width = fullscreenVideo.videoWidth;
            canvas.height = fullscreenVideo.videoHeight;
            context.drawImage(fullscreenVideo, 0, 0, canvas.width, canvas.height);
            photoDataUrl = canvas.toDataURL('image/jpeg');
            photoPreview.src = photoDataUrl;
            startView.classList.add('hidden');
            previewView.classList.remove('hidden');
            closeFullscreenCamera();
        }

        sendBtn.addEventListener('click', async () => {
            if (!photoDataUrl) return;
            statusMsg.textContent = "Envoi en cours...";
            sendBtn.disabled = true; retakeBtn.disabled = true;
            const base64Data = photoDataUrl.split(',')[1];
            const payload = { imageData: base64Data, mimeType: 'image/jpeg' };
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST', redirect: 'follow', body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                });
                statusMsg.textContent = "✅ Photo envoyée !";
                previewView.classList.add('hidden');
                startView.classList.remove('hidden');
                await loadGallery(); 
                setTimeout(() => { statusMsg.textContent = ""; }, 2000);
            } catch (error) { statusMsg.textContent = `❌ Erreur réseau.`;
            } finally { sendBtn.disabled = false; retakeBtn.disabled = false; }
        });

        async function loadGallery() {
            galleryStatus.textContent = "Chargement des images...";
            imageGrid.innerHTML = ''; 
            try {
                const response = await fetch(SCRIPT_URL);
                const result = await response.json();
                if (result.status === "success" && result.data) {
                    const images = result.data.reverse();
                    if (images.length === 0) {
                        galleryStatus.textContent = "Aucune photo dans la galerie.";
                    } else {
                        galleryStatus.textContent = "";
                        images.forEach(img => {
                            const link = document.createElement('a');
                            link.href = `https://drive.google.com/uc?export=view&id=${img.id}`;
                            link.target = "_blank";
                            const imgElement = document.createElement('img');
                            imgElement.src = `https://drive.google.com/thumbnail?id=${img.id}&sz=w250`;
                            link.appendChild(imgElement);
                            imageGrid.appendChild(link);
                        });
                    }
                } else { throw new Error(result.message || 'Erreur inconnue.'); }
            } catch (error) { galleryStatus.textContent = `❌ Erreur: ${error.message}`; }
        }

        function initializeApp() { loadGallery(); }
        initializeApp();
    </script>
</body>
</html>
