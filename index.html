<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Uploader & Galerie</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e9ebee;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px; /* Espace entre les deux blocs */
        }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            text-align: center;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
        }
        h1 {
            color: #1c1e21;
            margin-top: 0;
            font-size: 24px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .hidden { display: none; }
        .button-group { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }
        button { padding: 12px 20px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; font-weight: bold; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status, #gallery-status { margin-top: 15px; font-weight: bold; min-height: 24px; color: #606770; }
        
        /* Styles spécifiques */
        video, canvas, #photo-preview { max-width: 100%; border-radius: 8px; border: 1px solid #ddd; }
        #snap, #send { background-color: #1877f2; color: white; }
        #retake { background-color: #f5f6f7; color: #4b4f56; border: 1px solid #ccd0d5; }

        /* Styles de la Galerie */
        #image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; }
        #image-grid a { display: block; text-decoration: none; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; }
        #image-grid img { width: 100%; height: 120px; object-fit: cover; display: block; }
        #image-grid a:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <!-- PARTIE HAUTE : Outil de capture -->
    <div id="capture-card" class="card">
        <h1>Prendre une photo</h1>
        <div id="camera-view">
            <video id="video" autoplay playsinline></video>
            <div class="button-group"><button id="snap">Prendre la photo</button></div>
        </div>
        <div id="preview-view" class="hidden">
            <img id="photo-preview" alt="Aperçu de la photo">
            <div class="button-group"><button id="retake">Reprendre</button><button id="send">Envoyer</button></div>
        </div>
        <p id="status"></p>
    </div>

    <!-- PARTIE BASSE : Galerie -->
    <div id="gallery-card" class="card">
        <h1>Galerie</h1>
        <p id="gallery-status"></p>
        <div id="image-grid"></div>
    </div>
    
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzbdC-60zvJpOXhWBIgV3kdkIjI1u5M0m-5tajQrpWbrMOHfeNYWuBcflraX_5T4rr4/exec";

        // Éléments de capture
        const cameraView = document.getElementById('camera-view');
        const previewView = document.getElementById('preview-view');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photoPreview = document.getElementById('photo-preview');
        const statusMsg = document.getElementById('status');
        const snapBtn = document.getElementById('snap');
        const sendBtn = document.getElementById('send');
        const retakeBtn = document.getElementById('retake');

        // Éléments de la galerie
        const galleryStatus = document.getElementById('gallery-status');
        const imageGrid = document.getElementById('image-grid');
        
        let photoDataUrl = null;

        // Fonction pour charger et afficher la galerie
        async function loadGallery() {
            galleryStatus.textContent = "Chargement des images...";
            imageGrid.innerHTML = ''; 

            try {
                const response = await fetch(SCRIPT_URL);
                const result = await response.json();

                if (result.status === "success" && result.data) {
                    const images = result.data.reverse(); // Plus récentes en premier
                    if (images.length === 0) {
                        galleryStatus.textContent = "Aucune photo dans la galerie.";
                    } else {
                        galleryStatus.textContent = "";
                        images.forEach(img => {
                            const link = document.createElement('a');
                            link.href = `https://drive.google.com/uc?export=view&id=${img.id}`;
                            link.target = "_blank"; // Ouvre dans un nouvel onglet
                            link.title = `Voir ${img.name} en grand`;

                            const imgElement = document.createElement('img');
                            imgElement.src = `https://drive.google.com/thumbnail?id=${img.id}&sz=w250`; // Vignette
                            
                            link.appendChild(imgElement);
                            imageGrid.appendChild(link);
                        });
                    }
                } else {
                    throw new Error(result.message || 'Erreur inconnue.');
                }
            } catch (error) {
                galleryStatus.textContent = `❌ Erreur de chargement de la galerie: ${error.message}`;
            }
        }

        // Fonction pour initialiser la caméra
        async function initCamera() {
            statusMsg.textContent = "Chargement de la caméra...";
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                statusMsg.textContent = "Veuillez prendre une photo.";
            } catch (err) { statusMsg.textContent = "Erreur: Impossible d'accéder à la caméra."; }
        }

        // --- Événements des boutons de capture ---

        snapBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            photoDataUrl = canvas.toDataURL('image/jpeg');
            photoPreview.src = photoDataUrl;
            cameraView.classList.add('hidden');
            previewView.classList.remove('hidden');
            statusMsg.textContent = "Vérifiez la photo avant de l'envoyer.";
        });
        
        retakeBtn.addEventListener('click', () => {
            cameraView.classList.remove('hidden');
            previewView.classList.add('hidden');
            statusMsg.textContent = "Veuillez prendre une photo.";
        });

        sendBtn.addEventListener('click', async () => {
            if (!photoDataUrl) return;
            statusMsg.textContent = "Envoi en cours...";
            sendBtn.disabled = true;
            retakeBtn.disabled = true;

            const base64Data = photoDataUrl.split(',')[1];
            const payload = { imageData: base64Data, mimeType: 'image/jpeg' };
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST', redirect: 'follow', body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                });
                statusMsg.textContent = "✅ Photo envoyée ! Rafraîchissement de la galerie...";
                
                // Réinitialise la vue caméra
                cameraView.classList.remove('hidden');
                previewView.classList.add('hidden');
                
                // Rafraîchit la galerie pour afficher la nouvelle image
                await loadGallery(); 
                statusMsg.textContent = "Prêt pour une nouvelle photo.";

            } catch (error) { 
                statusMsg.textContent = `❌ Erreur réseau.`;
            } finally { 
                sendBtn.disabled = false; 
                retakeBtn.disabled = false; 
            }
        });

        // --- Démarrage de l'application ---
        function initializeApp() {
            initCamera();
            loadGallery();
        }

        initializeApp();

    </script>
</body>
</html>
