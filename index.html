<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Uploader & Galerie</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e9ebee; margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }
        .card {
            background-color: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            text-align: center; width: 100%; max-width: 600px; box-sizing: border-box;
        }
        h1 { color: #1c1e21; margin: 0 0 20px 0; font-size: 24px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .hidden { display: none !important; }
        .button-group { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }
        button { padding: 12px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; font-weight: bold; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status, #gallery-status { margin-top: 15px; font-weight: bold; min-height: 24px; color: #606770; }

        /* -- Styles de la capture -- */
        #photo-preview { max-width: 100%; border-radius: 8px; border: 1px solid #ddd; }
        #open-camera-btn { background-color: #1877f2; color: white; padding: 20px; font-size: 18px; }
        #send { background-color: #42b72a; color: white; }
        #retake { background-color: #f5f6f7; color: #4b4f56; border: 1px solid #ccd0d5; }
        
        /* -- NOUVEAU : Styles pour la vue Plein Écran -- */
        #fullscreen-camera-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        #fullscreen-video { width: 100%; height: 100%; object-fit: cover; }
        #fullscreen-controls {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px; box-sizing: border-box;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            display: flex; justify-content: center; align-items: center; gap: 20px;
        }
        #snap-fullscreen-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background-color: white; border: 4px solid rgba(255,255,255,0.5);
            padding: 0;
        }
        #close-fullscreen-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.4); color: white; font-size: 24px;
            border: none; width: 44px; height: 44px; border-radius: 50%;
            padding: 0; line-height: 44px;
        }

        /* -- Styles de la Galerie -- */
        #image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; }
        #image-grid a { display: block; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; }
        #image-grid img { width: 100%; height: 120px; object-fit: cover; display: block; }
        #image-grid a:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <!-- PARTIE HAUTE : Outil de capture -->
    <div id="capture-card" class="card">
        <h1>Prendre une photo</h1>
        <!-- Vue initiale avec le bouton pour ouvrir la caméra -->
        <div id="start-view">
            <button id="open-camera-btn">Ouvrir la Caméra</button>
        </div>
        <!-- Vue d'aperçu après la prise de photo -->
        <div id="preview-view" class="hidden">
            <img id="photo-preview" alt="Aperçu de la photo">
            <div class="button-group">
                <button id="retake">Reprendre</button>
                <button id="send">Envoyer</button>
            </div>
        </div>
        <p id="status"></p>
    </div>

    <!-- PARTIE BASSE : Galerie -->
    <div id="gallery-card" class="card">
        <h1>Galerie</h1>
        <p id="gallery-status"></p>
        <div id="image-grid"></div>
    </div>
    
    <!-- NOUVEAU : Vue plein écran pour la caméra (initialement cachée) -->
    <div id="fullscreen-camera-view" class="hidden">
        <video id="fullscreen-video" autoplay playsinline></video>
        <div id="fullscreen-controls">
            <button id="snap-fullscreen-btn" title="Prendre la photo"></button>
        </div>
        <button id="close-fullscreen-btn" title="Fermer la caméra">×</button>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzbdC-60zvJpOXhWBIgV3kdkIjI1u5M0m-5tajQrpWbrMOHfeNYWuBcflraX_5T4rr4/exec";

        // Éléments
        const startView = document.getElementById('start-view');
        const previewView = document.getElementById('preview-view');
        const photoPreview = document.getElementById('photo-preview');
        const statusMsg = document.getElementById('status');
        const galleryStatus = document.getElementById('gallery-status');
        const imageGrid = document.getElementById('image-grid');
        const canvas = document.getElementById('canvas');

        // Éléments de la vue plein écran
        const fullscreenView = document.getElementById('fullscreen-camera-view');
        const fullscreenVideo = document.getElementById('fullscreen-video');

        // Boutons
        const openCameraBtn = document.getElementById('open-camera-btn');
        const sendBtn = document.getElementById('send');
        const retakeBtn = document.getElementById('retake');
        const snapFullscreenBtn = document.getElementById('snap-fullscreen-btn');
        const closeFullscreenBtn = document.getElementById('close-fullscreen-btn');

        let photoDataUrl = null;
        let stream = null; // Pour garder une référence au flux de la caméra

        // --- Fonctions de la Caméra ---

        async function openFullscreenCamera() {
            statusMsg.textContent = "Démarrage de la caméra...";
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                fullscreenVideo.srcObject = stream;
                fullscreenView.classList.remove('hidden');
                statusMsg.textContent = "";
            } catch (err) {
                statusMsg.textContent = "Erreur: Impossible d'accéder à la caméra.";
            }
        }

        function closeFullscreenCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop()); // Éteint la caméra
            }
            fullscreenView.classList.add('hidden');
        }

        // --- Fonctions Principales ---

        async function loadGallery() { /* ... (inchangé) */ }

        function takePicture() {
            const context = canvas.getContext('2d');
            canvas.width = fullscreenVideo.videoWidth;
            canvas.height = fullscreenVideo.videoHeight;
            context.drawImage(fullscreenVideo, 0, 0, canvas.width, canvas.height);
            photoDataUrl = canvas.toDataURL('image/jpeg');
            
            // Afficher l'aperçu dans la vue principale
            photoPreview.src = photoDataUrl;
            startView.classList.add('hidden');
            previewView.classList.remove('hidden');

            // Fermer la vue plein écran
            closeFullscreenCamera();
        }

        // --- Événements des boutons ---

        openCameraBtn.addEventListener('click', openFullscreenCamera);
        closeFullscreenBtn.addEventListener('click', closeFullscreenCamera);
        snapFullscreenBtn.addEventListener('click', takePicture);
        
        // Le bouton "Reprendre" ouvre aussi la caméra plein écran
        retakeBtn.addEventListener('click', openFullscreenCamera);

        sendBtn.addEventListener('click', async () => {
            if (!photoDataUrl) return;
            statusMsg.textContent = "Envoi en cours...";
            sendBtn.disabled = true;
            retakeBtn.disabled = true;

            const base64Data = photoDataUrl.split(',')[1];
            const payload = { imageData: base64Data, mimeType: 'image/jpeg' };
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST', redirect: 'follow', body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                });
                statusMsg.textContent = "✅ Photo envoyée !";
                
                // Revenir à la vue de départ
                previewView.classList.add('hidden');
                startView.classList.remove('hidden');
                
                // Rafraîchir la galerie
                await loadGallery(); 
                setTimeout(() => { statusMsg.textContent = ""; }, 2000);

            } catch (error) { 
                statusMsg.textContent = `❌ Erreur réseau.`;
            } finally { 
                sendBtn.disabled = false; 
                retakeBtn.disabled = false; 
            }
        });

        // Démarrage et fonctions inchangées
        async function loadGallery() {
            galleryStatus.textContent = "Chargement des images...";
            imageGrid.innerHTML = ''; 
            try {
                const response = await fetch(SCRIPT_URL);
                const result = await response.json();
                if (result.status === "success" && result.data) {
                    const images = result.data.reverse();
                    if (images.length === 0) {
                        galleryStatus.textContent = "Aucune photo dans la galerie.";
                    } else {
                        galleryStatus.textContent = "";
                        images.forEach(img => {
                            const link = document.createElement('a');
                            link.href = `https://drive.google.com/uc?export=view&id=${img.id}`;
                            link.target = "_blank";
                            const imgElement = document.createElement('img');
                            imgElement.src = `https://drive.google.com/thumbnail?id=${img.id}&sz=w250`;
                            link.appendChild(imgElement);
                            imageGrid.appendChild(link);
                        });
                    }
                } else { throw new Error(result.message || 'Erreur inconnue.'); }
            } catch (error) { galleryStatus.textContent = `❌ Erreur: ${error.message}`; }
        }

        function initializeApp() {
            loadGallery();
        }

        initializeApp();
    </script>
</body>
</html>
